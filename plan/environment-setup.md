# Environment Setup Guide

This document describes the environment variables and setup needed for the CRM system.

## Project Structure

This is a **Turborepo monorepo** with the following structure:

| Directory | Description |
|-----------|-------------|
| `apps/marketing` | Next.js marketing site |
| `apps/portal` | React + Vite admin portal |
| `apps/client` | React + Vite customer portal |
| `backend` | Laravel 12 API |
| `packages/ui` | Shared UI components |
| `packages/hooks` | Shared React hooks |
| `packages/types` | Shared TypeScript types |

## Backend (.env)

Add the following to your Laravel backend `.env` file:

```env
# Application
APP_NAME="CRM System"
APP_ENV=local
APP_KEY=base64:... (generated by Laravel)
APP_DEBUG=true
APP_URL=http://localhost:8000

# Database (Supabase PostgreSQL)
DB_CONNECTION=pgsql
DB_HOST=db.YOUR_PROJECT_REF.supabase.co
DB_PORT=5432
DB_DATABASE=postgres
DB_USERNAME=postgres
DB_PASSWORD=your-database-password

# Supabase
SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
SUPABASE_KEY=your-supabase-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-supabase-service-role-key

# Redis (Railway) - Local Development uses public proxy
REDIS_CLIENT=phpredis
REDIS_HOST=gondola.proxy.rlwy.net
REDIS_PORT=14719
REDIS_PASSWORD=your-redis-password
REDIS_USERNAME=default

# Or use Redis URL format (for local dev - public proxy):
# REDIS_URL=redis://default:password@gondola.proxy.rlwy.net:14719

# Cache & Queue - Options: redis, database, file
CACHE_STORE=redis
QUEUE_CONNECTION=redis
SESSION_DRIVER=database

# Sanctum (SPA authentication) - All frontend app domains
SANCTUM_STATEFUL_DOMAINS=localhost:3000,localhost:3001,localhost:3002,localhost

# Broadcasting (Soketi - Pusher compatible)
BROADCAST_CONNECTION=pusher

PUSHER_APP_ID=your-soketi-app-id
PUSHER_APP_KEY=your-soketi-app-key
PUSHER_APP_SECRET=your-soketi-app-secret
PUSHER_HOST=your-soketi-host.railway.app
PUSHER_PORT=443
PUSHER_SCHEME=https
PUSHER_APP_CLUSTER=mt1

# Session
SESSION_LIFETIME=120
SESSION_DOMAIN=localhost

# Bunny CDN (for storage)
BUNNY_STORAGE_ZONE=your-storage-zone
BUNNY_STORAGE_KEY=your-storage-key
BUNNY_CDN_URL=https://your-pullzone.b-cdn.net
BUNNY_STREAM_LIBRARY_ID=your-library-id
BUNNY_STREAM_API_KEY=your-stream-api-key

# Note: Google OAuth is configured in Supabase Dashboard
# No backend config needed - Supabase handles OAuth providers

# Client Portal URL (for invitation emails)
CLIENT_URL=http://localhost:3002

# Email Configuration (SMTP2GO)
# Switch mailers by changing MAIL_MAILER: smtp2go, sendgrid, mailgun, smtp, log
MAIL_MAILER=smtp2go
MAIL_FROM_ADDRESS=noreply@yourdomain.com
MAIL_FROM_NAME="${APP_NAME}"

# SMTP2GO Settings
SMTP2GO_USERNAME=your-smtp2go-username
SMTP2GO_API_KEY=your-smtp2go-api-key
SMTP2GO_HOST=mail.smtp2go.com
SMTP2GO_PORT=2525

# Alternative: SendGrid (set MAIL_MAILER=sendgrid)
# SENDGRID_API_KEY=your-sendgrid-api-key

# Alternative: Mailgun (set MAIL_MAILER=mailgun)
# MAILGUN_USERNAME=your-mailgun-username
# MAILGUN_PASSWORD=your-mailgun-password
```

## Frontend Apps (.env)

Each frontend app has its own `.env` file with app-specific configuration.

### Portal App (`apps/portal/.env`)

```env
# Supabase Configuration
VITE_SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key

# API Configuration
VITE_API_URL=http://localhost:8000

# Note: WebSocket configuration is fetched from the backend API
# The portal calls /api/config/pusher to get Soketi connection details
```

### Client App (`apps/client/.env`)

```env
# Supabase Configuration
VITE_SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
VITE_SUPABASE_ANON_KEY=your-supabase-anon-key

# API Configuration
VITE_API_URL=http://localhost:8000

# Note: WebSocket configuration is fetched from the backend API
# The client calls /api/config/pusher to get Soketi connection details
```

### Marketing App (`apps/marketing/.env.local`)

```env
# API Configuration (for contact forms, etc.)
NEXT_PUBLIC_API_URL=http://localhost:8000

# Optional: Analytics, etc.
# NEXT_PUBLIC_GA_ID=your-google-analytics-id
```

## Supabase Setup

1. Create a new project at [supabase.com](https://supabase.com)
2. Go to Project Settings > Database to get:
   - Host (DB_HOST)
   - Database password (DB_PASSWORD)
3. Go to Project Settings > API to get:
   - URL (SUPABASE_URL)
   - anon public key (SUPABASE_KEY)
   - service_role secret key (SUPABASE_SERVICE_ROLE_KEY)

## Railway Redis Setup

### Creating Redis on Railway

1. Go to [railway.app](https://railway.app)
2. Create a new project or use existing Beemud project
3. Add Redis service (+ New → Database → Redis)
4. Go to Redis service → Variables tab

### Connection Details (Beemud Project)

| Variable | Local Development | Production (Railway) |
|----------|-------------------|----------------------|
| `REDIS_HOST` | `gondola.proxy.rlwy.net` | `redis.railway.internal` |
| `REDIS_PORT` | `14719` | `6379` |
| `REDIS_PASSWORD` | (from Railway variables) | `${{Redis.REDIS_PASSWORD}}` |
| `REDIS_USERNAME` | `default` | `default` |

### Local Development

For local development, use the **public proxy** endpoint:

```env
REDIS_HOST=gondola.proxy.rlwy.net
REDIS_PORT=14719
REDIS_PASSWORD=your-redis-password
REDIS_USERNAME=default
```

### Production (Railway Backend)

For production services running on Railway, use the **internal network** (faster, no external traffic):

```env
REDIS_HOST=redis.railway.internal
REDIS_PORT=6379
REDIS_PASSWORD=${{Redis.REDIS_PASSWORD}}
REDIS_USERNAME=default
```

Or use variable references in Railway:
- `REDIS_URL=${{Redis.REDIS_URL}}`

## Railway Soketi Setup

1. In your Railway project, add Soketi service (+ New → Template → search "Soketi")
2. Configure Soketi environment variables:
   ```
   SOKETI_DEFAULT_APP_ID=your-app-id
   SOKETI_DEFAULT_APP_KEY=your-app-key
   SOKETI_DEFAULT_APP_SECRET=your-app-secret
   ```
3. Get the public URL from the Soketi service settings
4. Use that URL as `PUSHER_HOST` (without https://)

## Supabase Auth Setup

### Enable Auth Providers

1. Go to your Supabase project dashboard
2. Navigate to "Authentication" > "Providers"
3. Enable Email provider (enabled by default)
4. Configure Google OAuth:
   - Go to [Google Cloud Console](https://console.cloud.google.com/)
   - Create OAuth credentials
   - Add redirect URI: `https://YOUR_PROJECT_REF.supabase.co/auth/v1/callback`
   - Copy Client ID and Secret to Supabase Google provider settings

### Auth Settings

1. Go to "Authentication" > "URL Configuration"
2. Set Site URL: `http://localhost:3001` (Portal) or your production URL
3. Add redirect URLs for all apps:
   - `http://localhost:3000/**` (Marketing)
   - `http://localhost:3001/**` (Portal)
   - `http://localhost:3002/**` (Client)

## Running the Application

### Install Dependencies (Root)

```bash
# From project root - installs all workspaces
pnpm install
```

### Backend (Laravel)

```bash
cd backend
composer install
php artisan key:generate
php artisan migrate
php artisan serve
```

### Queue Worker (for background jobs)

```bash
cd backend
php artisan queue:work redis
```

### Run All Frontend Apps (Turborepo)

```bash
# From project root - runs all apps in parallel
pnpm dev
```

### Run Individual Apps

```bash
# Portal (Admin dashboard)
pnpm --filter portal dev

# Client (Customer portal)
pnpm --filter client dev

# Marketing (Public site)
pnpm --filter marketing dev
```

### Build All Apps

```bash
# Build all apps for production
pnpm build

# Build specific app
pnpm --filter portal build
```

## Development URLs

| App | URL | Description |
|-----|-----|-------------|
| Marketing | http://localhost:3000 | Public marketing site |
| Portal | http://localhost:3001 | Admin/Staff dashboard |
| Client | http://localhost:3002 | Customer portal |
| Backend API | http://localhost:8000 | Laravel API |
| WebSocket | wss://your-soketi-host.railway.app | Railway Soketi |

## Testing WebSocket Connection

You can test if WebSocket is working by opening browser console and checking:

```javascript
// In browser console after loading the app
window.Echo.connector.pusher.connection.state
// Should return "connected"
```
